from langchain_openai import ChatOpenAI
from langchain.prompts import PromptTemplate
from langchain.chains import LLMChain
from typing import TypedDict, Annotated,Optional , Literal 
from dotenv import load_dotenv 
from pydantic import BaseModel , Field
import os


load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
print(OPENAI_API_KEY)

model = ChatOpenAI(model_name="gpt-4.1-2025-04-14", openai_api_key=OPENAI_API_KEY)

text = "'caller: Thank you for calling Zenith Bank’s loan servicing department, this is Amanda speaking, how may I assist you today?\n\ncustomer: Hi Amanda, this is Joseph Mallory, I’m calling regarding an auto loan I have with you. I received a confusing statement this month and I wanted to clarify a few things.\n\ncaller: Of course, Mr. Mallory. I’d be glad to help. May I have your loan account number, please?\n\ncustomer: Sure, it’s 785623-00921. Also, I noticed my monthly installment was higher this time, and there were some charges I didn’t recognize.\n\ncaller: Thank you for providing your account number. I’ll just pull up your details. May I also verify your date of birth and the address registered on the account?\n\ncustomer: Yes, my date of birth is May 12, 1986, and my address is 742 Evergreen Terrace, Springfield.\n\ncaller: Thank you. For verification, can you also confirm the last four digits of your social security number?\n\ncustomer: It’s 3427.\n\ncaller: Thank you, Mr. Mallory. I’ve accessed your loan record. Now, regarding the increased installment, I see there was an adjustment to your interest rate due to a delay in last month’s payment. Have you noticed any notifications about late fees or changes to the interest rate?\n\ncustomer: No, I don’t recall receiving any notification. I set up automatic payment, but I did notice that my salary hit my account a day late last month. Could that have triggered the issue?\n\ncaller: That could definitely be the cause. Our system automatically retries the payment for three business days, but if the funds aren’t sufficient, it classifies it as a missed payment and applies a late fee. It also triggers a temporary interest rate hike as described in your loan agreement, section 4.2(a).\n\ncustomer: That seems a bit harsh for a one-day delay, especially since payments are normally on time. Is there any possibility to reverse the late fee or reinstate my original interest rate?\n\ncaller: Under normal circumstances, these charges are automatic, but we do make exceptions based on customer history. I can see this is the first time in 18 months that you’ve missed a payment. Let me check if I can initiate a goodwill adjustment.\n\ncustomer: I would greatly appreciate that. Also, I saw a “processing charge” of $15.42. What does that refer to?\n\ncaller: That’s a good question. Let me review the line items on your statement. Ah, I see—on the 16th of last month, there was an attempted payment that was returned due to insufficient funds, which incurs a processing fee as per our fee schedule. Since you didn’t intentionally stop the payment, I can submit a request to have this refunded along with the late payment fee.\n\ncustomer: That would be wonderful. How long will it take to know if those fees can be reversed? And what happens if my payment next month is back at the usual amount—will the temporary rate hike affect future payments?\n\ncaller: Once I submit the request, you should receive a decision via email within three business days. If approved, the fees and the temporary interest hike will both be reversed retroactively. This means your next statement should reflect the standard repayment amount and the corrected principal balance.\n\ncustomer: Perfect. Another thing—if I wanted to make an extra payment to cover some of the principal, is there a penalty or restriction?\n\ncaller: No, there’s no penalty for early or extra payments with this specific auto loan product. You can make additional principal payments at any time. Just ensure you specify that it’s a principal-only payment when submitting it.\n\ncustomer: Got it. If the fees are not reversed, does that mean my new higher monthly payment becomes the default?\n\ncaller: No—the increased payment is temporary and only reflects the interest recalculation plus penalties. After that billing cycle, if no other payments are missed and the fees are reversed, you’ll revert to your original payment schedule and amounts.\n\ncustomer: Understood. What if the system doesn’t recognize my extra payment as principal-only? I’ve heard of cases where it just advances the due date rather than shortening the term.\n\ncaller: That’s an excellent point. The online portal defaults to applying extra amounts to future installments unless you select “Principal Only.” Alternatively, you can call us or write a note on the payment instructions, and our processing team will manually apply it to your principal. I recommend checking your next statement to confirm the reduction in the principal balance.\n\ncustomer: I suppose I’ll have to keep a close eye on that. One final thing—my insurance premium went up this year, and I see it reflected in my escrow balance. Can I pay the difference upfront rather than having it spread out over the year?\n\ncaller: Absolutely, you can make a lump-sum contribution to your escrow account at any time to cover the increased insurance cost. This can help lower your monthly escrow draw and keep your overall loan payment stable.\n\ncustomer: Excellent, Amanda, that answers pretty much everything. So just to recap—you’ll request a reversal of the late fee and processing charge, see if my rate can revert, and I can make principal or escrow contributions directly. Is there a reference number for our call?\n\ncaller: That’s correct, Mr. Mallory! I’ve documented everything under service ticket #B14793ML. You should get a confirmation email shortly, and if you have further questions, you can reference that ticket number in future correspondence.\n\ncustomer: Thank you so much, Amanda. This was a complicated situation, but I really appreciate your help navigating it.\n\ncaller: It was my pleasure, Mr. Mallory! Is there anything else I can assist you with today?\n\ncustomer: No, that covers everything for now. Have a great day!\n\ncaller: Thank you for choosing Zenith Bank. You too, have a wonderful day!'"

class schema(BaseModel):
    name : str= Field (description="name of the customer")
    tone : str  = Field(description="tone of the conversation")
    promise_to_pay : Literal['yes','no'] = Field(description="if the customer promised to pay")
    ptp_date : Optional[str] = Field(description="date when the customer promised to pay")
    concering : Optional[list[str]] = Field(description="any concerning thing said by customer that should be taken seriously by bank")


structured_output = model.with_structured_output(schema)
output = structured_output.invoke(f"read the following text and extract the information in a structured format: \n\n{text}")
print(output)
print(type(output))
